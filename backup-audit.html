<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>backup-audit — QCM</title>
  <style>
    :root{
      --bg:#0b0f17;
      --text:#e8edf7;
      --muted:#a9b4c7;
      --faint:#6f7b91;
      --line:#1c2a44;
      --ok:#31d0aa;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --accent:#8ab4ff;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --r: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      /* fond simplifié (moins agressif) */
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(138,180,255,.14), transparent 62%),
        radial-gradient(900px 520px at 90% 10%, rgba(49,208,170,.10), transparent 62%),
        var(--bg);
      color:var(--text);
      line-height:1.35;
    }
    .wrap{max-width: 1220px;margin: 0 auto;padding: 18px 14px 60px}
    header{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
    @media (max-width: 1100px){header{flex-direction:column}}
    .brand{display:flex;gap:12px;align-items:flex-start}
    .dot{
      width:14px;height:14px;border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--ok));
      box-shadow: 0 0 0 6px rgba(138,180,255,.10);
      margin-top:7px;flex:0 0 auto;
    }
    h1{margin:0;font-size:19px;letter-spacing:.2px}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      font-weight: 800;
      font-size: 13px;
    }
    button:hover{border-color: rgba(138,180,255,.45)}
    button:active{transform: translateY(1px)}
    button.secondary{background: transparent; box-shadow:none}

    .grid{display:grid;grid-template-columns: 310px 1.25fr .9fr;gap:14px;align-items:start}
    @media (max-width: 1150px){.grid{grid-template-columns:1fr}}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .hd h2{margin:0;font-size:13px;letter-spacing:.2px}
    .body{padding: 12px 14px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding: 6px 10px;border-radius: 999px;border:1px solid var(--line);
      color: var(--muted);font-size: 12px;white-space:nowrap;
    }
    .divider{height:1px;background: var(--line);margin: 12px 0}
    .small{font-size:12px;color:var(--muted)}
    .mutedline{color:var(--faint);font-size:12px}

    .navlist{display:flex;flex-direction:column;gap:8px}
    .navbtn{
      width:100%;
      text-align:left;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      color: var(--text);
      cursor:pointer;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      font-weight:850;font-size:13px;
    }
    .navbtn:hover{border-color: rgba(138,180,255,.45)}
    .navmeta{display:flex;align-items:center;gap:8px}
    .navhint{font-size:12px;color:var(--muted);font-weight:750}
    .check{
      width:18px;height:18px;border-radius:7px;
      border:1px solid rgba(255,255,255,.12);
      display:grid;place-items:center;
      background: rgba(255,255,255,.02);
      flex:0 0 auto;
    }
    .check.ok{border-color: rgba(49,208,170,.55); background: rgba(49,208,170,.12)}
    .check svg{display:none}
    .check.ok svg{display:block}

    .navactions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .navactions button{padding:8px 10px;font-size:12px}

    .cat{
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      overflow:hidden;
      margin: 12px 0;
    }
    .cat-hd{
      padding: 12px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .cat-title{display:flex;flex-direction:column;gap:3px}
    .cat-title .t{font-weight:950;font-size:13px}
    .cat-title .s{color:var(--muted);font-size:12px}
    .cat-bd{padding: 10px 12px 12px}

    .q{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      padding: 12px 12px 10px;
      margin: 10px 0;
      overflow:hidden;
    }
    .qhead{
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;margin-bottom: 8px;
    }
    .qtitle{margin:0;font-size:13px;color:var(--text);font-weight:900}
    .qmeta{color: var(--faint);font-size: 12px;white-space:nowrap;display:flex;align-items:center;gap:8px}
    .opts{display:grid;gap:8px;margin: 10px 0 6px}
    label.opt{
      display:flex;gap:10px;align-items:flex-start;
      padding: 10px 10px;border-radius: 12px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease;
    }
    label.opt:hover{border-color: rgba(138,180,255,.35);background: rgba(138,180,255,.05)}
    input[type="radio"]{margin-top:2px;accent-color: var(--accent)}
    .hint{margin: 8px 0 0;color: var(--faint);font-size: 12px}

    .completed-list{display:flex;flex-direction:column;gap:8px}
    details{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      overflow:hidden;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding: 10px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
      font-weight:900;
      font-size:13px;
    }
    summary::-webkit-details-marker{display:none}
    .sum-meta{display:flex;gap:8px;align-items:center}
    .badgeMini{
      font-size:11px;
      padding: 5px 9px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      background: rgba(255,255,255,.02);
      white-space:nowrap;
    }
    .ansItem{
      padding: 10px 10px;
      border-top:1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size: 13px;
    }
    .ansItem b{color:var(--text)}
    .ansItem .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .btnlink{
      padding: 7px 9px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      color: var(--text);
      font-weight:850;
      font-size:12px;
    }
    .btnlink:hover{border-color: rgba(138,180,255,.45)}
    .btnlink.danger{border-color: rgba(255,107,107,.35)}
    .btnlink.danger:hover{border-color: rgba(255,107,107,.70)}

    .kpis{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    .kpi{border: 1px solid var(--line);border-radius: 14px;padding: 10px 10px;background: rgba(0,0,0,.16)}
    .kpi .t{color: var(--muted);font-size: 12px;margin-bottom: 4px}
    .kpi .v{font-size: 18px;font-weight: 1000;letter-spacing:.2px}
    .bar{height: 10px;border-radius: 999px;background: rgba(255,255,255,.06);border: 1px solid rgba(255,255,255,.06);overflow:hidden;margin-top: 10px}
    .bar > div{height:100%;width: 0%;background: linear-gradient(90deg, var(--bad), var(--warn), var(--ok));transition: width .25s ease}
    .level{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding: 10px 12px;border-radius: 14px;border: 1px solid var(--line);
      background: rgba(0,0,0,.16); margin-top: 12px;
    }
    .badge{
      padding: 6px 10px;border-radius: 999px;font-size: 12px;font-weight: 1000;
      letter-spacing:.2px;border:1px solid rgba(255,255,255,.12);
    }
    .badge.ok{background: rgba(49,208,170,.15); color: var(--ok)}
    .badge.warn{background: rgba(255,204,102,.15); color: var(--warn)}
    .badge.bad{background: rgba(255,107,107,.15); color: var(--bad)}
    .rec{padding: 12px 12px;border-radius: 14px;border: 1px solid var(--line);background: rgba(0,0,0,.16); margin-top: 12px}
    .rec h3{margin:0 0 8px;font-size: 13px;letter-spacing:.2px}
    ul{margin:0;padding-left:18px;color:var(--muted);font-size:13px}
    li{margin: 6px 0}
    .tagrow{display:flex;gap:8px;flex-wrap:wrap;margin-top: 8px}
    .tag{font-size:11px;color: var(--muted);border: 1px solid rgba(255,255,255,.10);border-radius: 999px;padding: 6px 10px;background: rgba(255,255,255,.02)}

    .radar{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      background: rgba(0,0,0,.16);
      margin-top: 10px;
    }
    canvas{max-width:100%;height:auto;display:block}

    .info{
      width:18px;height:18px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      display:grid;place-items:center;
      cursor:pointer; flex:0 0 auto;
    }
    .info:hover{border-color: rgba(138,180,255,.45)}
    .tip{
      position: fixed;
      z-index: 1000;
      max-width: 520px;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(15,22,36,.96);
      box-shadow: var(--shadow);
      display:none;
    }
    .tip.show{display:block}
    .tip .tt{font-weight:1000;font-size:13px;margin:0 0 6px}
    .tip .tx{color:var(--muted);font-size:13px;margin:0}
    .tip .ex{margin-top:10px;border-top:1px solid rgba(255,255,255,.08);padding-top:10px;color:var(--muted);font-size:12px}
    .tip .ex b{color:var(--text)}
    .tip .close{
      position:absolute; top:10px; right:10px;
      width:28px;height:28px;border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--text);
      cursor:pointer;
      font-weight:1000;
    }

    .toast{
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(15,22,36,.92);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 10px 12px;
      color: var(--text);
      box-shadow: var(--shadow);
      display:none;
      gap:10px;align-items:center;
      max-width: 92vw;
      z-index: 50;
      font-size: 13px;
    }
    .toast.show{display:flex}
    .toast .k{color: var(--muted);font-weight:900}
    .toast .v{font-weight:1000}

    .issueRow{
      padding: 10px 10px;
      border-top:1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size: 13px;
    }
    .issueRow:first-child{border-top:none}
    .issueRow b{color:var(--text)}
    .issueRow .mutedline{margin-top:6px}
    .issueRow .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    /* Export dialog (léger) */
    dialog{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(15,22,36,.98);
      color: var(--text);
      box-shadow: var(--shadow);
      padding: 0;
      max-width: 520px;
      width: min(520px, 92vw);
    }
    dialog::backdrop{background: rgba(0,0,0,.55)}
    .dlg-hd{padding: 12px 14px; border-bottom:1px solid var(--line); font-weight:1000}
    .dlg-bd{padding: 12px 14px}
    .dlg-actions{display:flex; gap:10px; flex-wrap:wrap; padding: 0 14px 14px}
    .dlg-actions button{padding: 9px 10px; font-size:12px}
    .dlg-note{color: var(--muted); font-size:12px; margin: 0 0 10px}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="dot" aria-hidden="true"></div>
      <div>
        <h1>backup-audit — QCM</h1>
      </div>
    </div>
    <div class="top-actions">
      <button id="btnScore">Calculer</button>
      <button class="secondary" id="btnExport">Exporter</button>
      <button class="secondary" id="btnReset">Réinitialiser</button>
    </div>
  </header>

  <div class="grid">

    <!-- LEFT -->
    <aside class="card" aria-label="Navigation & réponses">
      <div class="hd">
        <h2>Navigation</h2>
        <span class="pill"><span id="answered">0</span>/<span id="total">0</span></span>
      </div>
      <div class="body">
        <div class="navlist" id="nav"></div>

        <div class="navactions">
          <button class="secondary" id="openAll">Tout ouvrir</button>
          <button class="secondary" id="closeAll">Tout fermer</button>
          <button class="secondary" id="showAllQs">Afficher toutes les questions</button>
        </div>

        <div class="divider"></div>

        <div class="section-title" style="display:flex;justify-content:space-between;align-items:center">
          <span>Réponses</span>
          <span class="mutedline" id="answeredHint">—</span>
        </div>

        <div class="completed-list" id="completed"></div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="card" aria-label="Questionnaire">
      <div class="hd">
        <h2>Questions</h2>
        <span class="pill" id="midHint">—</span>
      </div>
      <div class="body" id="cats"></div>
    </main>

    <!-- RIGHT -->
    <aside class="card" aria-label="Score et toile">
      <div class="hd">
        <h2>Résultats</h2>
        <span class="pill">0 → 100</span>
      </div>
      <div class="body">
        <div class="kpis">
          <div class="kpi">
            <div class="t">Score</div>
            <div class="v" id="score">—</div>
          </div>
          <div class="kpi">
            <div class="t">Couverture</div>
            <div class="v" id="coverage">—</div>
          </div>
        </div>
        <div class="bar"><div id="barFill"></div></div>

        <div class="level">
          <div>
            <div class="mutedline">Niveau</div>
            <div class="v" id="levelText" style="font-weight:1000">—</div>
          </div>
          <div class="badge bad" id="badge">—</div>
        </div>

        <div class="radar">
          <div class="mutedline" id="radarHint" style="margin-bottom:8px;">Répondez puis calculez.</div>
          <canvas id="radar" width="520" height="460"></canvas>
        </div>

        <div class="rec">
          <h3>Ce que ça suggère</h3>
          <ul id="insights"><li>—</li></ul>
          <div class="tagrow" id="tags"></div>

          <div style="margin-top:10px">
            <details id="issuesBox">
              <summary>
                <span>À vérifier</span>
                <span class="sum-meta">
                  <span class="badgeMini" id="issuesCount">0</span>
                </span>
              </summary>
              <div id="issues">
                <div class="issueRow"><div class="mutedline">Aucune incohérence détectée.</div></div>
              </div>
            </details>
          </div>
        </div>

        <div class="rec">
          <h3>Priorités</h3>
          <ul id="priorities"><li>—</li></ul>
        </div>
      </div>
    </aside>

  </div>
</div>

<!-- Tooltip -->
<div class="tip" id="tip" role="dialog" aria-hidden="true">
  <button class="close" id="tipClose" title="Fermer">×</button>
  <p class="tt" id="tipTitle">—</p>
  <p class="tx" id="tipText">—</p>
  <div class="ex" id="tipExtra" style="display:none"></div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite">
  <span class="k">Score</span> <span class="v" id="toastScore">—</span>
  <span class="mutedline" id="toastHint"></span>
</div>

<!-- Export dialog -->
<dialog id="exportDlg">
  <div class="dlg-hd">Exporter</div>
  <div class="dlg-bd">
    <p class="dlg-note">
      PDF : ouvre un rapport imprimable (vous faites “Imprimer” → “Enregistrer en PDF”).<br>
      HTML : télécharge un fichier complet, lisible et archivable.
    </p>
  </div>
  <div class="dlg-actions">
    <button id="expHtml">Rapport HTML</button>
    <button id="expPdf">PDF</button>
    <button class="secondary" id="expJson">JSON (technique)</button>
    <button class="secondary" id="expCancel">Annuler</button>
  </div>
</dialog>

<script>
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }

  const AXES = [
    { key:"Gouvernance", label:"Gouvernance" },
    { key:"Résilience",  label:"Résilience" },
    { key:"Sécurité",    label:"Sécurité" },
    { key:"Restauration",label:"Restauration" },
    { key:"Exploitation",label:"Exploitation" },
    { key:"Couverture",  label:"Couverture" },
    { key:"Design",      label:"Design" },
    { key:"Conformité",  label:"Conformité" },
  ];

  const GLOSSARY = {
    "321": {
      title: "3-2-1 (et pourquoi les technos différentes comptent)",
      text: "3 copies, 2 supports/technos, 1 hors site. Le but est de réduire les pannes corrélées et la compromission unique.",
      extra: `
        <b>Pourquoi “2 technos” ?</b><br>
        • Deux copies sur le même NAS/cluster = mêmes risques (erreur admin, ransomware, bug firmware, corruption).<br>
        • Deux technos différentes = modes de panne différents (objet immuable, bande, stockage isolé…).<br><br>
        <b>Piège :</b> “hors site” mais mêmes identités/admins → une compromission peut toucher toutes les copies.
      `
    },
    "immut": {
      title: "Immutabilité / WORM",
      text: "Object Lock/WORM : impossible de modifier/supprimer avant une date. Très utile contre ransomware.",
      extra: "<b>Question clé :</b> qui peut lever la protection ou supprimer la policy ?"
    },
    "domain": {
      title: "Serveur backup et domaine AD",
      text: "Si le serveur de backup est joint au domaine de prod, une compromission AD peut s’étendre au backup.",
      extra: "<b>Objectif :</b> casser le chemin AD → backup (hors domaine / isolation / bastion)."
    },
    "repo": {
      title: "Repo en écriture avec comptes “courants”",
      text: "Si Domain Admin / admins habituels peuvent écrire sur le dépôt, un attaquant qui vole ces accès peut supprimer/chiffrer les sauvegardes.",
      extra: `
        <b>Ce qu’on veut :</b><br>
        • comptes dédiés backup (pas DA), MFA/JIT/bastion<br>
        • accès réseau limité vers le storage<br>
        • journaux hors de portée<br>
        • immutabilité si possible
      `
    },
    "integrity": {
      title: "Vérification d’intégrité (bitrot, corruption, sabotage silencieux)",
      text: "Un backup ‘OK’ peut être corrompu. Les vérifications (checksums/health checks) détectent la corruption avant l’incident.",
      extra: `
        <b>Preuves typiques :</b><br>
        • rapports de “verify/health check” réguliers<br>
        • checksums / scan intégrité<br>
        • restaurations de contrôle (fichiers/VM/bases)
      `
    },
    "coverage2": {
      title: "Couverture des ‘trucs oubliés’",
      text: "La reprise échoue souvent sur des éléments non sauvegardés : configs, secrets, identités, certificats, SaaS, dépôts Git/IaC…",
      extra: `
        <b>Exemples :</b> AD/IDP, M365/Google Workspace, secrets vault, certificats/PKI, DNS, configs réseau, Git, Terraform, pipelines CI/CD.
      `
    },
    "keys": {
      title: "Chiffrement des backups + gestion des clés",
      text: "Chiffrer sans séparation des clés = protection fragile. La vraie question : qui peut lire/extraire les clés ?",
      extra: `
        <b>Bon signe :</b> KMS/rotation, accès minimal, séparation des rôles, logs d’accès aux clés.
      `
    },
    "saferestore": {
      title: "Restauration en environnement isolé (safe restore)",
      text: "Restaurer directement en prod peut réinfecter. Un bac à sable permet de valider et scanner avant remise en prod.",
      extra: "<b>Preuves :</b> runbook, réseau isolé, tests documentés, contrôles AV/EDR/scan post-restore."
    },
    "sabotage": {
      title: "Détection de sabotage des backups (attaque silencieuse)",
      text: "Un attaquant peut d’abord casser la rétention, supprimer des points, ou dégrader les jobs avant de chiffrer.",
      extra: "<b>Preuves :</b> alertes sur changements de policy, suppressions, anomalies, baisse taux de succès, logs hors de portée."
    }
  };

  function opt(label, score, tags=[], priority=null, extra=null){
    return { label, score, tags, priority, extra };
  }
  function q(id, title, weight, explainId, axisKey, mode, hint, options, condition=null){
    return { id, title, weight, explainId, axisKey, mode, hint, options, condition };
  }

  function getAnswer(qid){
    const chosen = document.querySelector(`input[name="${qid}"]:checked`);
    if (!chosen) return null;
    const optIndex = Number((chosen.id || "").split("_").pop());
    const score = Number(chosen.dataset.score || 0);
    const label = (chosen.closest("label")?.querySelector("div > div")?.textContent || "").trim();
    return { qid, chosen, optIndex, score, label };
  }

  function isQuestionActive(qu){
    if (!qu.condition) return true;
    const a = getAnswer(qu.condition.qid);
    if (!a) return false;
    if (typeof qu.condition.minScore === "number") return a.score >= qu.condition.minScore;
    if (typeof qu.condition.eqScore === "number") return a.score === qu.condition.eqScore;
    return true;
  }

  function clearAnswer(qid){
    $$(`input[name="${qid}"]`).forEach(r => r.checked = false);
    if (qid === "a4") $$('input[name="v321"]').forEach(v => v.checked = false);
  }

  function enforceConditions(){
    const all = allQuestions();
    for (const qu of all){
      const active = isQuestionActive(qu);
      if (!active){
        // si la question devient inactive, on supprime sa réponse (sinon score/rapport ment)
        if (document.querySelector(`input[name="${qu.id}"]:checked`)) clearAnswer(qu.id);
      }
    }
  }

  const VARIANTS_321 = [
    { key:"321",       label:"3-2-1",       desc:"base", add: 0 },
    { key:"321-1",     label:"3-2-1-1",     desc:"+1 offline/immuable", add: 2 },
    { key:"321-1-0",   label:"3-2-1-1-0",   desc:"+ tests/vérifs", add: 4 },
    { key:"gfs",       label:"GFS",         desc:"rétention (jour/sem/mois)", add: 1 }
  ];

  // Bibliothèque rapport (détails “longs”)
  const REPORT_LIBRARY = {
    "a4": {
      title: "Stratégie 3-2-1",
      why: [
        "Sans 3-2-1, une panne ou compromission peut emporter prod + backups.",
        "‘2 supports/technos’ réduit les pannes corrélées (même firmware/cluster/admin error).",
        "‘Hors site’ n’aide vraiment que si l’accès est séparé (identités/tenant/clé)."
      ],
      evidence: [
        "Schéma des copies (où, quoi, comment, qui y accède).",
        "Liste des identités/roles qui peuvent supprimer/modifier.",
        "Logs de rétention / immutabilité / suppressions."
      ]
    },
    "q321_5": {
      title: "Vérification d’intégrité",
      why: [
        "Un job ‘OK’ peut produire une sauvegarde inutilisable (corruption, bitrot, sabotage).",
        "L’intégrité se prouve par des vérifications et des restaurations de contrôle."
      ],
      evidence: [
        "Rapports de verify/health-check planifiés.",
        "Checksums ou scans d’intégrité.",
        "Historique de restaurations de contrôle (preuves, temps, résultat)."
      ]
    },
    "q321_6": {
      title: "Couverture des éléments ‘oubliés’",
      why: [
        "Les incidents échouent souvent sur des dépendances : secrets, certificats, configs, identité, SaaS.",
        "Être ‘bon sur les VM’ ne suffit pas si l’auth/DNS/PKI/SaaS n’est pas récupérable."
      ],
      evidence: [
        "Inventaire des dépendances (secrets, PKI, DNS, SaaS, Git/IaC).",
        "Procédures de restauration de ces briques.",
        "Tests bout-en-bout (reprise applicative)."
      ]
    },
    "qkey_1": {
      title: "Chiffrement + gestion des clés",
      why: [
        "Chiffrer sans séparation des clés revient à mettre la clé sous le paillasson.",
        "La question centrale : qui peut lire/extraire les clés (KMS, comptes cloud, admins) ?"
      ],
      evidence: [
        "Politiques KMS/rotation, rôles et journaux d’accès aux clés.",
        "Preuves de chiffrement (au repos / transit) selon techno.",
        "Test de restauration avec gestion des clés (scénario réaliste)."
      ]
    },
    "qrest_1": {
      title: "Safe-restore (environnement isolé)",
      why: [
        "Restaurer directement en prod peut réinfecter ou réintroduire des fichiers malveillants.",
        "L’isolation permet de valider/scan avant remise en prod."
      ],
      evidence: [
        "Réseau/sandbox isolé, runbook, critères de validation.",
        "Procédure de scan/EDR/AV après restauration.",
        "Exercices documentés."
      ]
    },
    "qops_1": {
      title: "Détection sabotage backup",
      why: [
        "Un attaquant peut d’abord dégrader les backups (rétention, suppressions, échecs) avant de chiffrer.",
        "Sans alertes sur les changements critiques, on découvre trop tard."
      ],
      evidence: [
        "Alertes sur changements de policy/rétention/immutabilité.",
        "Alertes sur suppressions massives ou anomalies.",
        "Logs centralisés hors de portée des admins ‘courants’."
      ]
    }
  };

  const CATS = [
    {
      id:"cat-audit-gouv",
      title:"Audit — Gouvernance & exigences",
      subtitle:"objectifs, périmètre, rétention",
      questions: [
        q("a1","RPO/RTO : objectifs chiffrés, documentés, validés ?",6,null,"Gouvernance","Audit","Sans objectifs, vous ne savez pas si c’est suffisant.", [
          opt("Oui, validés + documentés + revus",6,["Gouvernance"]),
          opt("Partiel (approx / non validé)",3,["Gouvernance"],"Formaliser RPO/RTO avec le métier et les rendre traçables."),
          opt("Non / inconnu",0,["Gouvernance"],"Définir RPO/RTO : sans ça, vous pilotez à l’aveugle.")
        ]),
        q("a2","Inventaire & criticité : savez-vous ce qui est critique et qui en est propriétaire ?",6,null,"Couverture","Audit","Sans inventaire, vous sauvegardez souvent “ce qui est visible”.", [
          opt("Oui (inventaire, criticité, owners)",6,["Couverture"]),
          opt("Partiel",3,["Couverture"],"Faire inventaire + classification + owners (données, apps, secrets, SaaS)."),
          opt("Non",0,["Couverture"],"Dresser inventaire/criticité : sinon la sauvegarde couvrira mal.")
        ]),
        q("a3","Rétention : règles définies (technique + légal) et maîtrisées ?",6,null,"Conformité","Audit","Trop court = pertes. Trop long = risques + coûts.", [
          opt("Oui (politiques par type + revue)",6,["Conformité","Gouvernance"]),
          opt("Partiel (par défaut)",3,["Conformité"],"Définir rétention par type de données + contraintes légales."),
          opt("Non / inconnu",0,["Conformité"],"Définir une rétention : sinon c’est arbitraire.")
        ]),
      ]
    },
    {
      id:"cat-audit-res",
      title:"Audit — Résilience & architecture",
      subtitle:"3-2-1, hors site, offline/air-gap",
      questions: [
        q("a4","Stratégie 3-2-1 : laquelle appliquez-vous réellement ?",12,"321","Résilience","Audit","Si tout est dans le même périmètre, un incident peut tout emporter.", [
          opt("Oui, on applique une stratégie (je peux préciser laquelle)",8,["Résilience"],null,{ show321Variants:true }),
          opt("Partiel",4,["Résilience"],"Rendre la séparation réelle (comptes/roles, réseau, storage, logs)."),
          opt("Non",0,["Résilience"],"Mettre 3-2-1 (idéalement 3-2-1-1-0).")
        ]),
        q("a5","Copie hors site : l’accès est-il réellement séparé ?",8,null,"Résilience","Audit","Si les mêmes identités y accèdent, ce n’est pas un vrai filet de sécurité.", [
          opt("Oui : tenant/compte séparé + clés séparées + accès minimal",8,["Résilience"]),
          opt("Partiel : même tenant mais rôles/comptes séparés + MFA + logs indépendants",6,["Résilience"],"Renforcer l’indépendance : clés/identités séparées + restrictions réseau + logs."),
          opt("Faible : même tenant et/ou mêmes admins/identités",2,["Résilience"],"Séparer tenant/compte/identités : sinon une compromission touche tout."),
          opt("Non / inconnu",0,["Résilience"],"Créer une copie hors site réellement indépendante.")
        ], { qid:"a4", minScore:4 }),
        q("a6","Copie offline/air-gap : avez-vous une copie difficilement atteignable en cas de compromission ?",8,null,"Résilience","Audit","Sans copie isolée, vous dépendez d’un seul scénario.", [
          opt("Oui (offline/isolée) + procédure",8,["Résilience","Sécurité"]),
          opt("Partiel (isolée mais accessible via mêmes identités)",4,["Résilience"],"Mettre une vraie isolation (identités, réseau, procédure)."),
          opt("Non",0,["Résilience"],"Ajouter une copie offline/air-gap ou immuable.")
        ], { qid:"a4", minScore:4 }),

        /* ✅ AJOUT : Q321-5 (branching après A4) */
        q("q321_5","Vérification d’intégrité : détectez-vous corruption/bitrot avant l’incident ?",4,"integrity","Restauration","Audit","Sans vérif, vous pouvez découvrir un backup inutilisable au pire moment.", [
          opt("Oui (health-check/verify réguliers + alertes)",4,["Restauration","Exploitation"]),
          opt("Partiel (ponctuel / manuel)",2,["Restauration"],"Automatiser verify/health checks + conserver preuves."),
          opt("Non / inconnu",0,["Restauration"],"Mettre une vérification d’intégrité (et la prouver).")
        ], { qid:"a4", minScore:4 }),

        /* ✅ AJOUT : Q321-6 (branching après A4) */
        q("q321_6","Couverture : le plan inclut-il aussi secrets/configs/identités/certificats/SaaS ?",6,"coverage2","Couverture","Audit","Le restore échoue souvent sur ce qui n’est pas sauvegardé (secrets, PKI, DNS, SaaS…).", [
          opt("Oui (inventorié + sauvegardé + testé)",6,["Couverture","Restauration"]),
          opt("Partiel",3,["Couverture"],"Lister les dépendances (secrets, PKI, DNS, SaaS, Git/IaC) et les inclure."),
          opt("Non",0,["Couverture"],"Faire l’inventaire des dépendances et les intégrer au plan.")
        ], { qid:"a4", minScore:4 }),
      ]
    },
    {
      id:"cat-audit-sec",
      title:"Audit — Sécurité",
      subtitle:"immutabilité, AD, repo, accès",
      questions: [
        q("a7","Immutabilité/WORM : vos sauvegardes sont-elles protégées contre suppression/chiffrement ?",10,"immut","Sécurité","Audit","Si un attaquant peut détruire les backups, vous n’avez pas de plan B.", [
          opt("Oui (WORM/Object Lock) + vérifié",10,["Sécurité"]),
          opt("Partiel",5,["Sécurité"],"Ajouter immutabilité + séparation des identités + journaux."),
          opt("Non / inconnu",0,["Sécurité"],"Mettre des sauvegardes immuables et isolées : priorité ransomware.")
        ]),
        q("a8","Serveur de backup : est-il joint au domaine AD de production ?",6,"domain","Sécurité","Audit","Si oui, une compromission AD peut s'étendre au backup.", [
          opt("Non (hors domaine / forêt d’admin dédiée)",6,["Sécurité","Résilience"]),
          opt("Oui, joint mais isolation forte (bastion/réseau/durcissement)",3,["Sécurité"],"Planifier la sortie du domaine de prod, ou isoler fortement (réseau, bastion, MFA)."),
          opt("Oui, joint au domaine de production",0,["Sécurité"],"Casser la chaîne AD→backup (hors domaine / isolation drastique).")
        ]),
        q("a8b","Identités : l’administration backup utilise-t-elle des comptes dédiés séparés des comptes courants / DA ?",4,null,"Sécurité","Audit","Hors domaine avec comptes partagés = séparation illusoire.", [
          opt("Oui : comptes dédiés + MFA + bastion/JIT + logs",4,["Sécurité","Résilience"]),
          opt("Partiel : comptes dédiés mais MFA/JIT incomplet",2,["Sécurité"],"Compléter : MFA + bastion/JIT + rotation + traces."),
          opt("Non / inconnu (comptes courants / DA / partagés)",0,["Sécurité"],"Créer des identités backup dédiées et indépendantes des comptes de prod/DA.")
        ]),
        q("a9","Dépôt backup (repo) : qui peut écrire/supprimer ?",10,"repo","Sécurité","Audit","Si des comptes “courants” écrivent sur le repo, une compromission peut tout effacer.", [
          opt("Écriture uniquement via compte de service backup + réseau restreint + MFA/JIT pour admins",10,["Sécurité"]),
          opt("Écriture via comptes dédiés backup (pas DA) + contrôles, mais MFA/JIT pas partout",7,["Sécurité"],"Standardiser MFA/JIT + restrictions réseau + logs hors de portée."),
          opt("Écriture via admins IT généraux (pas DA)",3,["Sécurité"],"Retirer l’écriture aux admins généraux : comptes dédiés backup + contrôles."),
          opt("DA / comptes courants / inconnu",0,["Sécurité"],"Retirer l’accès en écriture aux identités courantes : sinon le repo tombe.")
        ]),
        q("a10","Serveur de backup : AV/EDR maîtrisé (exceptions, surveillance) ?",8,"av","Exploitation","Audit","Agent absent = compromission facile. Agent mal réglé = backups cassés.", [
          opt("Oui (EDR/AV + exceptions + supervision)",8,["Exploitation","Sécurité"]),
          opt("Partiel (agent présent mais incidents)",4,["Exploitation"],"Configurer exclusions, monitorer l’impact, valider avec l’éditeur backup."),
          opt("Non",0,["Exploitation"],"Mettre un contrôle adapté (durcissement + monitoring).")
        ]),

        /* ✅ AJOUT : QKEY-1 */
        q("qkey_1","Chiffrement : sauvegardes chiffrées + gestion des clés réellement séparée ?",6,"keys","Sécurité","Audit","Chiffrer ne suffit pas : si les mêmes admins ont les clés, la protection est faible.", [
          opt("Oui (KMS/rotation + accès minimal + logs)",6,["Sécurité","Conformité"]),
          opt("Partiel (chiffré mais séparation/rotation incomplète)",3,["Sécurité"],"Séparer les rôles clés/données, activer rotation et journaliser l’accès."),
          opt("Non / inconnu",0,["Sécurité"],"Activer chiffrement et sécuriser la gestion des clés (KMS, rôles, logs).")
        ]),
      ]
    },
    {
      id:"cat-audit-rest",
      title:"Audit — Restauration & preuves",
      subtitle:"tests réels, reprise applicative",
      questions: [
        q("a11","Tests de restauration : vous restaurez réellement, avec preuves et temps mesuré ?",10,null,"Restauration","Audit","Un job OK n’est pas une restauration.", [
          opt("Oui (mensuel/trimestriel) + preuves",10,["Restauration"]),
          opt("Occasionnel",5,["Restauration"],"Planifier des restaurations régulières + conserver preuves (temps, succès)."),
          opt("Jamais / très rare",0,["Restauration"],"Faire des tests réels : sinon vous découvrirez trop tard.")
        ]),
        q("a12","Reprise applicative : test bout-en-bout (dépendances, auth, données) ?",8,null,"Restauration","Audit","Restaurer une base ne prouve pas que le service repart.", [
          opt("Oui, scénarios bout-en-bout",8,["Restauration"]),
          opt("Partiel (technique seulement)",4,["Restauration"],"Élargir : dépendances, intégrations, secrets, DNS, certificats."),
          opt("Non",0,["Restauration"],"Tester la reprise applicative, pas juste la restauration technique.")
        ]),

        /* ✅ AJOUT : QREST-1 */
        q("qrest_1","Safe-restore : restaurez-vous d’abord en environnement isolé avant remise en prod ?",6,"saferestore","Restauration","Audit","Restaurer en prod peut réinfecter. Une zone isolée réduit ce risque.", [
          opt("Oui (sandbox isolé + validation/scan)",6,["Restauration","Sécurité"]),
          opt("Partiel (quelques cas)",3,["Restauration"],"Formaliser un parcours safe-restore + preuves."),
          opt("Non",0,["Restauration"],"Mettre un environnement isolé pour restaurations sensibles.")
        ]),
      ]
    },
    {
      id:"cat-audit-ops",
      title:"Audit — Exploitation",
      subtitle:"alerting, dérives, capacité",
      questions: [
        q("a13","Supervision : alertes fiables sur échecs/dérives + traitement ?",8,null,"Exploitation","Audit","Une sauvegarde non surveillée se dégrade.", [
          opt("Oui (alerting + escalade + suivi)",8,["Exploitation"]),
          opt("Partiel",4,["Exploitation"],"Fiabiliser alertes et instaurer une routine de traitement."),
          opt("Non",0,["Exploitation"],"Mettre alerting + routine : sinon ça va finir par casser.")
        ]),
        q("a14","Capacité : croissance et fenêtres de backup modélisées + seuils ?",6,null,"Design","Audit","Quand la capacité manque, on coupe la rétention.", [
          opt("Oui (seuils + prévisions)",6,["Design","Exploitation"]),
          opt("Partiel",3,["Design"],"Modéliser croissance et ajouter alertes de capacité."),
          opt("Non",0,["Design"],"Surveiller capacité/fenêtres : sinon perte de maîtrise.")
        ]),

        /* ✅ AJOUT : QOPS-1 */
        q("qops_1","Détection sabotage : alertes sur suppressions/changements de policy/rétention/anomalies ?",6,"sabotage","Exploitation","Audit","Un attaquant peut dégrader les backups avant de frapper. Sans alertes, vous ne le verrez pas.", [
          opt("Oui (alertes + logs hors de portée)",6,["Exploitation","Sécurité"]),
          opt("Partiel",3,["Exploitation"],"Ajouter alertes ciblées (policy, suppressions, anomalies) + centraliser les logs."),
          opt("Non",0,["Exploitation"],"Mettre des alertes ‘anti-sabotage’ et journaliser hors de portée.")
        ]),
      ]
    },
    {
      id:"cat-plan",
      title:"Cible — Plan",
      subtitle:"architecture, responsabilités, tests",
      questions: [
        q("b1a","Architecture cible : on sait où sont les copies (on-prem/cloud/hybride) et pourquoi ?",4,null,"Design","Plan","Sans modèle clair, ça finit en bricolage.", [
          opt("Oui (schéma / modèle clair)",4,["Design","Gouvernance"]),
          opt("Partiel",2,["Design"],"Documenter l’architecture cible (flux, copies, dépendances)."),
          opt("Non",0,["Design"],"Définir l’architecture cible.")
        ]),
        q("b1b","Responsabilités (RACI) : qui exécute, qui valide, qui peut supprimer ?",2,null,"Gouvernance","Plan","Le flou tue les tests et les restores.", [
          opt("Oui (RACI clair)",2,["Gouvernance"]),
          opt("Partiel",1,["Gouvernance"],"Écrire un RACI minimal (restore, validation, changements, droits)."),
          opt("Non",0,["Gouvernance"],"Définir qui fait quoi (RACI).")
        ]),
        q("b2","Immutabilité prévue (durées, exceptions, comptes séparés) ?",8,"immut","Sécurité","Plan","Si ce n’est pas dans le design, ça n’arrivera pas.", [
          opt("Oui",8,["Sécurité","Design"]),
          opt("En discussion",4,["Sécurité"],"Trancher et intégrer l’immutabilité au design."),
          opt("Non",0,["Sécurité"],"Ajouter immutabilité au design.")
        ]),
        q("b3","Plan de tests futur : calendrier + scénarios + preuves + responsable ?",6,null,"Restauration","Plan","Un test sans responsable saute en premier.", [
          opt("Oui",6,["Restauration","Gouvernance"]),
          opt("Partiel",3,["Restauration"],"Définir plan de tests (scénarios, critères, ownership)."),
          opt("Non",0,["Restauration"],"Planifier les tests dès le design.")
        ]),
      ]
    },
  ];

  function allQuestions(){ return CATS.flatMap(c => c.questions); }
  function activeQuestions(){ return allQuestions().filter(isQuestionActive); }
  function activeQuestionsByCat(cat){ return cat.questions.filter(isQuestionActive); }

  // --- Rendering ---
  function render(){
    const nav = $("#nav");
    nav.innerHTML = "";
    for (const cat of CATS){
      const btn = document.createElement("button");
      btn.className = "navbtn";
      btn.type = "button";
      btn.id = `navbtn-${cat.id}`;
      btn.innerHTML = `
        <span>${escapeHtml(cat.title)}</span>
        <span class="navmeta">
          <span class="navhint" id="navhint-${cat.id}">—</span>
          <span class="check" id="navcheck-${cat.id}" aria-hidden="true">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
              <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </span>
      `;
      btn.addEventListener("click", () => {
        const el = document.getElementById(cat.id);
        if (!el) return;
        el.scrollIntoView({behavior:"smooth", block:"start"});
      });
      nav.appendChild(btn);
    }

    const cats = $("#cats");
    cats.innerHTML = "";
    for (const cat of CATS){
      const sec = document.createElement("section");
      sec.className = "cat";
      sec.id = cat.id;

      const hd = document.createElement("div");
      hd.className = "cat-hd";
      hd.innerHTML = `
        <div class="cat-title">
          <div class="t">${escapeHtml(cat.title)}</div>
          <div class="s">${escapeHtml(cat.subtitle)}</div>
        </div>
        <span class="pill" id="pill-${cat.id}">—</span>
      `;
      sec.appendChild(hd);

      const bd = document.createElement("div");
      bd.className = "cat-bd";

      for (const qu of cat.questions){
        bd.appendChild(renderQuestion(qu, cat.id));
      }

      sec.appendChild(bd);
      cats.appendChild(sec);
    }

    document.addEventListener("change", onAnyChange);
    onAnyChange();
    drawRadar(null);
  }

  function renderQuestion(qu, catId){
    const root = document.createElement("div");
    root.className = "q";
    root.id = `q-${qu.id}`;
    root.dataset.qid = qu.id;
    root.dataset.weight = qu.weight;
    root.dataset.axis = qu.axisKey;
    root.dataset.cat = catId;

    const info = qu.explainId ? `
      <span class="info" tabindex="0" role="button" aria-label="Explication" data-tip="${escapeHtml(qu.explainId)}">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
          <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" stroke-width="2"/>
          <path d="M12 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 7h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        </svg>
      </span>
    ` : "";

    root.innerHTML = `
      <div class="qhead">
        <p class="qtitle">${escapeHtml(qu.title)}</p>
        <div class="qmeta">
          <span>${escapeHtml(qu.mode)} · ${qu.weight} pts</span>
          ${info}
        </div>
      </div>
    `;

    const opts = document.createElement("div");
    opts.className = "opts";

    qu.options.forEach((op, idx) => {
      const id = `${qu.id}_${idx}`;
      const lbl = document.createElement("label");
      lbl.className = "opt";
      lbl.setAttribute("for", id);
      lbl.innerHTML = `
        <input type="radio" name="${escapeHtml(qu.id)}" id="${escapeHtml(id)}"
          data-score="${op.score}"
          data-tags="${(op.tags||[]).join(",")}"
          data-priority="${escapeHtml(op.priority || "")}"
          data-extra="${escapeHtml(JSON.stringify(op.extra || null))}">
        <div>
          <div style="font-weight:850">${escapeHtml(op.label)}</div>
          <div class="mutedline">Score : ${op.score}/${qu.weight}</div>
        </div>
      `;
      opts.appendChild(lbl);
    });

    root.appendChild(opts);

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = qu.hint;
    root.appendChild(hint);

    // Variante 3-2-1 (a4)
    if (qu.id === "a4"){
      const sub = document.createElement("div");
      sub.className = "q";
      sub.style.marginTop = "10px";
      sub.style.background = "rgba(0,0,0,.10)";
      sub.style.display = "none";
      sub.id = "sub_321";
      sub.innerHTML = `
        <div class="qhead">
          <p class="qtitle">Variante 3-2-1 (bonus)</p>
          <div class="qmeta"><span>optionnel</span></div>
        </div>
        <div class="opts" id="vlist"></div>
        <div class="hint">Choisissez ce qui est réellement en place.</div>
      `;
      const list = sub.querySelector("#vlist");
      for (const v of VARIANTS_321){
        const row = document.createElement("label");
        row.className = "opt";
        row.innerHTML = `
          <input type="radio" name="v321" data-add="${v.add}" data-key="${escapeHtml(v.key)}">
          <div>
            <div style="font-weight:900">${escapeHtml(v.label)} <span class="mutedline">(+${v.add} pts)</span></div>
            <div class="mutedline">${escapeHtml(v.desc)}</div>
          </div>
        `;
        list.appendChild(row);
      }
      root.appendChild(sub);

      root.addEventListener("change", () => {
        const chosen = document.querySelector(`input[name="a4"]:checked`);
        const show = chosen && Number(chosen.dataset.score||0) >= 8;
        sub.style.display = show ? "block" : "none";
        if (!show) $$('input[name="v321"]').forEach(x => x.checked = false);
      });
    }

    return root;
  }

  // --- Dynamic ---
  function onAnyChange(){
    enforceConditions();
    updateAnsweredCount();
    updateCategoryProgress();
    rebuildCompletedPanel();
    applyHideAnswered();
  }

  function updateAnsweredCount(){
    const act = activeQuestions();
    const answered = act.filter(q => document.querySelector(`input[name="${q.id}"]:checked`)).length;

    $("#answered").textContent = answered;
    $("#total").textContent = act.length;

    $("#answeredHint").textContent = `${answered} réponse(s)`;
    $("#midHint").textContent = `${Math.max(0, act.length-answered)} restante(s)`;

    const coverage = act.length ? Math.round((answered / act.length) * 100) : 0;
    $("#coverage").textContent = coverage + "%";
  }

  function updateCategoryProgress(){
    for (const cat of CATS){
      const act = activeQuestionsByCat(cat);
      const total = act.length;
      const ans = act.filter(q => document.querySelector(`input[name="${q.id}"]:checked`)).length;

      const pill = $(`#pill-${cat.id}`);
      if (pill) pill.textContent = total ? `${ans}/${total}` : "—";

      const hint = $(`#navhint-${cat.id}`);
      if (hint) hint.textContent = total ? `${ans}/${total}` : "—";

      const check = $(`#navcheck-${cat.id}`);
      if (check) check.classList.toggle("ok", total > 0 && ans === total);

      // masque nav si la catégorie n’a aucune question active
      const navbtn = $(`#navbtn-${cat.id}`);
      if (navbtn) navbtn.style.display = total ? "" : "none";
    }
  }

  function applyHideAnswered(){
    const all = allQuestions();

    // questions: hide answered, hide inactive always
    for (const q of all){
      const el = document.getElementById(`q-${q.id}`);
      if (!el) continue;

      const active = isQuestionActive(q);
      if (!active){
        el.style.display = "none";
        continue;
      }
      const answered = !!document.querySelector(`input[name="${q.id}"]:checked`);
      if (!window.__showAll && answered) el.style.display = "none";
      else el.style.display = "";
    }

    // categories: hide when empty (no active unanswered)
    for (const cat of CATS){
      const sec = document.getElementById(cat.id);
      if (!sec) continue;
      if (window.__showAll){ sec.style.display = activeQuestionsByCat(cat).length ? "" : "none"; continue; }

      const act = activeQuestionsByCat(cat);
      if (!act.length){ sec.style.display = "none"; continue; }
      const remaining = act.some(q => !document.querySelector(`input[name="${q.id}"]:checked`));
      sec.style.display = remaining ? "" : "none";
    }
  }

  function revealQuestion(id){
    const q = allQuestions().find(x => x.id === id);
    if (!q || !isQuestionActive(q)) return;

    const el = document.getElementById(`q-${id}`);
    if (!el) return;
    window.__showAll = true;
    applyHideAnswered();
    el.scrollIntoView({behavior:"smooth", block:"center"});
    el.style.outline = "2px solid rgba(138,180,255,.45)";
    setTimeout(()=> el.style.outline = "", 1200);
  }

  function rebuildCompletedPanel(){
    const panel = $("#completed");
    panel.innerHTML = "";

    for (const cat of CATS){
      const act = activeQuestionsByCat(cat);
      const answeredQs = act.filter(q => document.querySelector(`input[name="${q.id}"]:checked`));
      if (answeredQs.length === 0) continue;

      const det = document.createElement("details");
      det.open = false;

      det.innerHTML = `
        <summary>
          <span>${escapeHtml(cat.title)}</span>
          <span class="sum-meta">
            <span class="badgeMini">${answeredQs.length}/${act.length}</span>
          </span>
        </summary>
      `;

      for (const q of answeredQs){
        const chosen = document.querySelector(`input[name="${q.id}"]:checked`);
        const baseScore = Number(chosen?.dataset.score || 0);
        const optIndex = Number((chosen?.id || "").split("_").pop());
        const optLabel = q.options[optIndex]?.label || "—";

        let score = baseScore;
        let extraLine = "";
        if (q.id === "a4" && score >= 8){
          const v = document.querySelector('input[name="v321"]:checked');
          if (v){
            const key = v.dataset.key;
            const add = Number(v.dataset.add||0);
            score = Math.min(q.weight, score + add);
            extraLine = `<div class="mutedline">Variante : <b>${escapeHtml(key)}</b> (bonus +${add})</div>`;
          }
        }

        const item = document.createElement("div");
        item.className = "ansItem";
        item.innerHTML = `
          <div><b>${escapeHtml(q.title)}</b></div>
          <div class="mutedline">Réponse : ${escapeHtml(optLabel)} · Score ${score}/${q.weight}</div>
          ${extraLine}
          <div class="row">
            <button class="btnlink" data-edit="${escapeHtml(q.id)}">Modifier</button>
            <button class="btnlink danger" data-clear="${escapeHtml(q.id)}">Effacer</button>
          </div>
        `;
        det.appendChild(item);
      }

      panel.appendChild(det);
    }

    if (panel.children.length === 0){
      panel.innerHTML = `<div class="small" style="color:var(--faint)">Aucune réponse pour l’instant.</div>`;
    }

    panel.querySelectorAll("[data-edit]").forEach(btn => {
      btn.addEventListener("click", (e) => revealQuestion(e.currentTarget.dataset.edit));
    });

    panel.querySelectorAll("[data-clear]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const id = e.currentTarget.dataset.clear;
        clearAnswer(id);
        onAnyChange();
      });
    });
  }

  // --- Issues (doutes) ---
  function detectIssues(){
    const issues = [];
    const push = (title, text, related=[]) => issues.push({ title, text, related });

    const a4 = getAnswer("a4");
    const a5 = getAnswer("a5");
    const a7 = getAnswer("a7");
    const a8 = getAnswer("a8");
    const a8b = getAnswer("a8b");
    const a9 = getAnswer("a9");
    const a11 = getAnswer("a11");
    const v321 = document.querySelector('input[name="v321"]:checked');
    const vKey = v321?.dataset?.key || null;

    if (a8 && a8.score === 6 && a8b && a8b.score === 0){
      push(
        "Séparation d’identité absente",
        "Vous indiquez “hors domaine”, mais l’admin backup n’est pas séparée. Un accès volé “du quotidien” peut encore toucher le backup.",
        ["a8","a8b","a9"]
      );
    }

    if (vKey === "321-1-0"){
      if (!a11) {
        push("3-2-1-1-0 sans test renseigné","Vous annoncez des vérifs/tests mais les tests de restauration ne sont pas renseignés.",["a4","a11"]);
      } else if (a11.score < 10){
        push("3-2-1-1-0 vs tests","3-2-1-1-0 suppose des tests solides. Ici c’est partiel.",["a4","a11"]);
      }
    }

    if (a4 && a4.score >= 8 && a5 && a5.score <= 2){
      push(
        "Copie hors site peu séparée",
        "Vous dites appliquer une stratégie, mais la copie ‘hors site’ semble accessible via les mêmes identités/tenant/admins. Une compromission peut toucher les deux copies.",
        ["a4","a5"]
      );
    }

    if (a7 && a7.score === 10 && a9 && a9.score === 0){
      push(
        "Immutabilité vs accès repo",
        "Vous déclarez l’immutabilité vérifiée, mais le repo est accessible en écriture par des comptes très puissants (ou inconnus). À re-valider : qui peut désactiver/supprimer la protection ?",
        ["a7","a9","a8b"]
      );
    }

    return issues;
  }

  function renderIssues(issues){
    $("#issuesCount").textContent = String(issues.length);
    const box = $("#issues");

    if (!issues.length){
      box.innerHTML = `<div class="issueRow"><div class="mutedline">Aucune incohérence détectée.</div></div>`;
      return;
    }

    box.innerHTML = "";
    for (const it of issues){
      const div = document.createElement("div");
      div.className = "issueRow";
      div.innerHTML = `
        <div><b>${escapeHtml(it.title)}</b></div>
        <div class="mutedline">${escapeHtml(it.text)}</div>
        <div class="row">
          ${(it.related||[]).map(qid => `<button class="btnlink" data-jump="${escapeHtml(qid)}">Revoir ${escapeHtml(qid.toUpperCase())}</button>`).join("")}
        </div>
      `;
      box.appendChild(div);
    }

    box.querySelectorAll("[data-jump]").forEach(btn => {
      btn.addEventListener("click", (e) => revealQuestion(e.currentTarget.dataset.jump));
    });
  }

  // --- Score & Radar ---
  function compute(){
    const actQ = activeQuestions();

    let raw = 0;
    let max = 0;
    const priorities = [];
    const tagsCount = new Map();
    const missing = [];

    const axisRaw = new Map(AXES.map(a => [a.key, 0]));
    const axisMax = new Map(AXES.map(a => [a.key, 0]));

    for (const q of actQ){
      max += q.weight;
      axisMax.set(q.axisKey, (axisMax.get(q.axisKey)||0) + q.weight);

      const chosen = document.querySelector(`input[name="${q.id}"]:checked`);
      if (!chosen){ missing.push(q); continue; }

      let sc = Number(chosen.dataset.score || 0);

      if (q.id === "a4" && sc >= 8){
        const v = document.querySelector('input[name="v321"]:checked');
        if (v){
          const add = Number(v.dataset.add || 0);
          sc = Math.min(q.weight, sc + add);
        }
      }

      raw += sc;
      axisRaw.set(q.axisKey, (axisRaw.get(q.axisKey)||0) + sc);

      const tags = (chosen.dataset.tags || "").split(",").map(s => s.trim()).filter(Boolean);
      for (const t of tags) tagsCount.set(t, (tagsCount.get(t)||0) + 1);

      if (sc <= (q.weight/2)){
        const pr = (chosen.dataset.priority || "").trim();
        if (pr) priorities.push(pr);
      }
    }

    const answered = actQ.length - missing.length;
    const coverage = actQ.length ? answered / actQ.length : 0;

    const normalized = max ? Math.round((raw / max) * 100 * (0.65 + 0.35 * coverage)) : 0;

    const level = getLevel(normalized, coverage);
    const insights = buildInsights(normalized, coverage, missing.length);
    updateUI(normalized, coverage, level, insights, priorities, tagsCount, missing);

    renderIssues(detectIssues());
    drawRadar(buildRadarValues(axisRaw, axisMax, coverage));

    return {
      normalized, raw, max, coverage,
      axisRaw: Object.fromEntries(axisRaw),
      axisMax: Object.fromEntries(axisMax)
    };
  }

  function getLevel(score, coverage){
    if (coverage < 0.7) return { text: "Incomplet", badge: "warn" };
    if (score >= 85) return { text: "Solide", badge: "ok" };
    if (score >= 70) return { text: "Correct", badge: "warn" };
    if (score >= 50) return { text: "Fragile", badge: "bad" };
    return { text: "Critique", badge: "bad" };
  }

  function buildInsights(score, coverage, missingCount){
    const lines = [];
    if (missingCount) lines.push(`Il manque ${missingCount} réponse(s) : score approximatif.`);
    if (coverage < 0.7) lines.push("Couverture faible : angles morts probables.");
    if (score >= 85) lines.push("OK. Reste : preuves de restauration et séparation réelle des accès.");
    else if (score >= 70) lines.push("Correct, mais une compromission d’identités ne doit pas pouvoir effacer toutes les copies.");
    else if (score >= 50) lines.push("Vous avez des backups. La reprise fiable est encore discutable (tests / protections).");
    else lines.push("Priorité : immutabilité + séparation d’accès + tests réels.");
    return lines;
  }

  function updateUI(score, coverage, level, insights, priorities, tagsCount, missing){
    $("#score").textContent = score;
    $("#barFill").style.width = Math.max(0, Math.min(100, score)) + "%";
    $("#levelText").textContent = level.text;

    const badge = $("#badge");
    badge.className = "badge " + level.badge;
    badge.textContent = level.badge === "ok" ? "OK" : (level.badge === "warn" ? "À renforcer" : "Risque");

    $("#coverage").textContent = Math.round(coverage * 100) + "%";

    const ul = $("#insights");
    ul.innerHTML = "";
    insights.forEach(t => {
      const li = document.createElement("li");
      li.textContent = t;
      ul.appendChild(li);
    });

    const tags = $("#tags");
    tags.innerHTML = "";
    const sortedTags = [...tagsCount.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8);
    if (sortedTags.length){
      for (const [t,c] of sortedTags){
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = `${t} · ${c}`;
        tags.appendChild(span);
      }
    } else {
      const span = document.createElement("span");
      span.className = "tag";
      span.textContent = "—";
      tags.appendChild(span);
    }

    const pr = $("#priorities");
    pr.innerHTML = "";
    const uniq = [...new Set(priorities)].slice(0, 12);
    if (uniq.length){
      uniq.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p;
        pr.appendChild(li);
      });
    } else {
      const li = document.createElement("li");
      li.textContent = missing.length ? "Répondez au reste pour faire ressortir des priorités." : "—";
      pr.appendChild(li);
    }

    showToast(score, coverage, level);
  }

  function showToast(score, coverage, level){
    const t = $("#toast");
    $("#toastScore").textContent = score + "/100";
    const cov = Math.round(coverage * 100);
    $("#toastHint").textContent = `· Couverture ${cov}% · ${level.text}`;
    t.classList.add("show");
    clearTimeout(showToast._to);
    showToast._to = setTimeout(()=> t.classList.remove("show"), 2200);
  }

  function buildRadarValues(axisRaw, axisMax, coverage){
    const values = AXES.map(a => {
      const mx = axisMax.get(a.key) || 0;
      const rw = axisRaw.get(a.key) || 0;
      return mx ? (rw/mx) : 0;
    });
    return { values, coverage };
  }

  function drawRadar(data){
    const canvas = $("#radar");
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    const cx = Math.floor(w/2), cy = Math.floor(h/2)+8;
    const r = Math.min(w,h) * 0.34;

    const levels = 5;
    for (let i=1;i<=levels;i++){
      const rr = r * (i/levels);
      ctx.beginPath();
      ctx.arc(cx,cy,rr,0,Math.PI*2);
      ctx.strokeStyle = "rgba(255,255,255,0.09)";
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    const n = AXES.length;
    for (let i=0;i<n;i++){
      const ang = (Math.PI*2 * i / n) - Math.PI/2;
      const x = cx + Math.cos(ang)*r;
      const y = cy + Math.sin(ang)*r;

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.lineTo(x,y);
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 1;
      ctx.stroke();

      const lx = cx + Math.cos(ang)*(r+20);
      const ly = cy + Math.sin(ang)*(r+20);

      ctx.font = "12px ui-sans-serif, system-ui";
      ctx.fillStyle = "rgba(232,237,247,0.92)";
      ctx.textAlign = (Math.cos(ang) > 0.25) ? "left" : (Math.cos(ang) < -0.25 ? "right" : "center");
      ctx.textBaseline = (Math.sin(ang) > 0.25) ? "top" : (Math.sin(ang) < -0.25 ? "bottom" : "middle");
      ctx.fillText(AXES[i].label, lx, ly);
    }

    if (!data){
      $("#radarHint").textContent = "Répondez puis calculez.";
      return;
    }
    const cov = Math.round((data.coverage||0)*100);
    $("#radarHint").textContent = `Couverture ${cov}%`;

    const vals = data.values;

    ctx.beginPath();
    for (let i=0;i<n;i++){
      const ang = (Math.PI*2 * i / n) - Math.PI/2;
      const rr = r * Math.max(0, Math.min(1, vals[i]));
      const x = cx + Math.cos(ang)*rr;
      const y = cy + Math.sin(ang)*rr;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.fillStyle = "rgba(138,180,255,0.18)";
    ctx.strokeStyle = "rgba(138,180,255,0.75)";
    ctx.lineWidth = 2;
    ctx.fill();
    ctx.stroke();

    for (let i=0;i<n;i++){
      const ang = (Math.PI*2 * i / n) - Math.PI/2;
      const rr = r * Math.max(0, Math.min(1, vals[i]));
      const x = cx + Math.cos(ang)*rr;
      const y = cy + Math.sin(ang)*rr;
      ctx.beginPath();
      ctx.arc(x,y,4,0,Math.PI*2);
      ctx.fillStyle = "rgba(49,208,170,0.85)";
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.25)";
      ctx.lineWidth = 1;
      ctx.stroke();
    }
  }

  // --- Export: JSON / Rapport HTML / PDF (print-to-pdf) ---
  function buildReportData(){
    const res = compute();
    const actQ = activeQuestions();

    const answers = actQ.map(q => {
      const chosen = document.querySelector(`input[name="${q.id}"]:checked`);
      if (!chosen){
        return { id:q.id, title:q.title, axis:q.axisKey, weight:q.weight, option:null, score:null };
      }
      const optIndex = Number((chosen.id || "").split("_").pop());
      let score = Number(chosen.dataset.score||0);
      let variant = null;

      if (q.id === "a4" && score >= 8){
        const v = document.querySelector('input[name="v321"]:checked');
        if (v){
          const add = Number(v.dataset.add||0);
          const key = v.dataset.key;
          score = Math.min(q.weight, score + add);
          variant = { key, add };
        }
      }

      return {
        id:q.id,
        title:q.title,
        axis:q.axisKey,
        weight:q.weight,
        option: q.options[optIndex]?.label || "—",
        score,
        variant
      };
    });

    const axisScores = AXES.map(a => {
      const raw = res.axisRaw[a.key] ?? 0;
      const mx  = res.axisMax[a.key] ?? 0;
      const pct = mx ? Math.round((raw/mx)*100) : 0;
      return { axis:a.key, pct, raw, max:mx };
    });

    const issues = detectIssues();

    let radarPng = null;
    try{
      radarPng = $("#radar").toDataURL("image/png");
    }catch(e){ radarPng = null; }

    return {
      generated_at: new Date().toISOString(),
      score_total: res.normalized,
      coverage: res.coverage,
      level: getLevel(res.normalized, res.coverage),
      axisScores,
      issues,
      answers,
      radarPng
    };
  }

  function buildDetailedReportHTML(data){
    const covPct = Math.round((data.coverage||0)*100);
    const issuesCount = data.issues?.length || 0;

    const axisTable = data.axisScores.map(a => `
      <tr>
        <td>${escapeHtml(a.axis)}</td>
        <td style="text-align:right">${a.pct}%</td>
        <td style="text-align:right">${a.raw}/${a.max}</td>
      </tr>
    `).join("");

    const issuesHtml = issuesCount ? data.issues.map(it => `
      <div class="blk">
        <div class="h">${escapeHtml(it.title)}</div>
        <div class="t">${escapeHtml(it.text)}</div>
        <div class="s">Liens : ${(it.related||[]).map(x=>escapeHtml(x.toUpperCase())).join(", ")}</div>
      </div>
    `).join("") : `<div class="blk"><div class="t">Aucune incohérence détectée.</div></div>`;

    const answersHtml = data.answers.map(a => {
      const lib = REPORT_LIBRARY[a.id];
      const ratio = (a.score == null || a.weight === 0) ? null : (a.score / a.weight);
      let verdict = "Non renseigné";
      if (ratio != null){
        if (ratio >= 0.8) verdict = "Plutôt maîtrisé";
        else if (ratio >= 0.45) verdict = "Partiel";
        else verdict = "Faible / Risque";
      }

      const why = lib?.why?.length ? `<ul>${lib.why.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>` : "";
      const evidence = lib?.evidence?.length ? `<ul>${lib.evidence.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>` : "";

      const variantLine = a.variant ? `<div class="s">Variante 3-2-1 : <b>${escapeHtml(a.variant.key)}</b> (bonus +${a.variant.add})</div>` : "";

      return `
        <div class="blk">
          <div class="h">${escapeHtml(a.title)}</div>
          <div class="t"><b>Réponse :</b> ${escapeHtml(a.option || "—")} ${variantLine}</div>
          <div class="s"><b>Score :</b> ${a.score == null ? "—" : `${a.score}/${a.weight}`} · <b>Lecture :</b> ${escapeHtml(verdict)} · <b>Axe :</b> ${escapeHtml(a.axis)}</div>
          ${why ? `<div class="t"><b>Pourquoi ça compte :</b>${why}</div>` : ""}
          ${evidence ? `<div class="t"><b>Preuves attendues :</b>${evidence}</div>` : ""}
        </div>
      `;
    }).join("");

    const radarImg = data.radarPng ? `<img src="${data.radarPng}" alt="Radar" style="max-width:100%;border:1px solid #1c2a44;border-radius:12px">` : "";

    return `
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rapport — backup-audit</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:24px; color:#111; line-height:1.35}
  h1{margin:0 0 6px}
  .meta{color:#444; margin:0 0 18px}
  .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
  @media print{ .noPrint{display:none} body{margin:12mm} }
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
  .card{border:1px solid #ddd; border-radius:12px; padding:14px}
  .kpi{display:flex; gap:14px; flex-wrap:wrap}
  .k{border:1px solid #eee; border-radius:10px; padding:10px 12px; min-width: 160px}
  .k .t{color:#666; font-size:12px}
  .k .v{font-size:22px; font-weight:900}
  table{width:100%; border-collapse:collapse; margin-top:10px}
  th,td{border-bottom:1px solid #eee; padding:8px 6px; text-align:left; font-size:13px}
  th{color:#444}
  .blk{border:1px solid #eee; border-radius:12px; padding:12px; margin:10px 0}
  .blk .h{font-weight:900}
  .blk .t{margin-top:6px; color:#222; font-size:13px}
  .blk .s{margin-top:6px; color:#555; font-size:12px}
  .btn{display:inline-block; padding:10px 12px; border-radius:10px; border:1px solid #ddd; background:#fafafa; cursor:pointer}
  ul{margin:6px 0 0 18px}
</style>
</head>
<body>
  <div class="noPrint" style="margin-bottom:12px">
    <button class="btn" onclick="window.print()">Imprimer / Enregistrer en PDF</button>
  </div>

  <h1>Rapport d’audit — backup-audit</h1>
  <p class="meta">
    Généré : ${escapeHtml(data.generated_at)} · Couverture : ${covPct}% · Score : ${data.score_total}/100 · Niveau : ${escapeHtml(data.level?.text || "—")}
  </p>

  <div class="grid">
    <div class="card">
      <div class="kpi">
        <div class="k"><div class="t">Score</div><div class="v">${data.score_total}/100</div></div>
        <div class="k"><div class="t">Couverture</div><div class="v">${covPct}%</div></div>
        <div class="k"><div class="t">Incohérences</div><div class="v">${issuesCount}</div></div>
      </div>
      <h3 style="margin:14px 0 6px">Scores par axe</h3>
      <table>
        <thead><tr><th>Axe</th><th style="text-align:right">%</th><th style="text-align:right">Brut</th></tr></thead>
        <tbody>${axisTable}</tbody>
      </table>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Toile</h3>
      ${radarImg || "<div style='color:#666;font-size:13px'>Radar indisponible.</div>"}
      <div style="color:#666;font-size:12px;margin-top:10px">
        Lecture rapide : les creux = angles morts (axes faibles).
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 10px">À vérifier (cohérence)</h3>
    ${issuesHtml}
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 10px">Détail des réponses</h3>
    ${answersHtml}
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 10px">Notes</h3>
    <div style="color:#555;font-size:13px">
      Ce rapport n’est pas une preuve de sécurité. Il est une base : ce qui compte ensuite, ce sont les preuves (tests, logs, architecture, séparation réelle des accès).
    </div>
  </div>
</body>
</html>
    `;
  }

  function downloadText(filename, content, mime="text/plain"){
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  }

  function exportJsonTech(){
    const result = compute();
    const actQ = activeQuestions();

    const answers = {};
    for (const q of actQ){
      const chosen = document.querySelector(`input[name="${q.id}"]:checked`);
      if (!chosen){ answers[q.id] = null; continue; }

      const optIndex = Number((chosen.id || "").split("_").pop());
      let score = Number(chosen.dataset.score||0);
      let v321 = null;
      if (q.id === "a4" && score >= 8){
        const v = document.querySelector('input[name="v321"]:checked');
        if (v){
          const add = Number(v.dataset.add||0);
          const key = v.dataset.key;
          score = Math.min(q.weight, score + add);
          v321 = { key, add };
        }
      }

      answers[q.id] = {
        mode: q.mode,
        axis: q.axisKey,
        weight: q.weight,
        score,
        option: q.options[optIndex]?.label || "—",
        variant_321: v321
      };
    }

    const payload = {
      generated_at: new Date().toISOString(),
      active_questions_total: actQ.length,
      score_total: result.normalized,
      coverage: result.coverage,
      issues: detectIssues(),
      answers
    };

    const text = JSON.stringify(payload, null, 2);
    navigator.clipboard?.writeText(text).then(()=>{
      showToast(result.normalized, result.coverage, {text:"Copié", badge:"ok"});
    }).catch(()=>{
      downloadText("backup-audit.json", text, "application/json");
    });
  }

  function exportReportHtml(){
    const data = buildReportData();
    const html = buildDetailedReportHTML(data);
    downloadText("backup-audit_rapport.html", html, "text/html;charset=utf-8");
    showToast(data.score_total, data.coverage, {text:"Rapport HTML exporté", badge:"ok"});
  }

  function exportReportPdf(){
    const data = buildReportData();
    const html = buildDetailedReportHTML(data);

    const w = window.open("", "_blank");
    if (!w){
      alert("Popup bloquée. Autorisez l’ouverture d’onglets pour exporter en PDF.");
      return;
    }
    w.document.open();
    w.document.write(html);
    w.document.close();

    // tentative d'ouverture du dialogue d'impression
    w.onload = () => {
      try{ w.focus(); w.print(); }catch(e){}
    };
  }

  // --- Reset ---
  function resetAll(){
    $$('input[type="radio"]').forEach(i => i.checked = false);
    $$('input[name="v321"]').forEach(i => i.checked = false);
    window.__showAll = false;

    $("#score").textContent = "—";
    $("#barFill").style.width = "0%";
    $("#levelText").textContent = "—";
    const badge = $("#badge");
    badge.className = "badge bad";
    badge.textContent = "—";
    $("#tags").innerHTML = "";
    $("#priorities").innerHTML = "<li>—</li>";
    $("#issuesCount").textContent = "0";
    $("#issues").innerHTML = `<div class="issueRow"><div class="mutedline">Aucune incohérence détectée.</div></div>`;
    drawRadar(null);
    onAnyChange();
  }

  // --- Tooltip ---
  const tip = $("#tip");
  const tipTitle = $("#tipTitle");
  const tipText = $("#tipText");
  const tipExtra = $("#tipExtra");

  function showTip(explainId, anchorRect){
    const g = GLOSSARY[explainId];
    if (!g) return;

    tipTitle.textContent = g.title;
    tipText.textContent = g.text;

    if (g.extra){
      tipExtra.style.display = "block";
      tipExtra.innerHTML = g.extra;
    } else {
      tipExtra.style.display = "none";
      tipExtra.innerHTML = "";
    }

    tip.classList.add("show");
    tip.setAttribute("aria-hidden","false");

    const margin = 12;
    const w = tip.offsetWidth;
    const h = tip.offsetHeight;

    let left = anchorRect.left + (anchorRect.width/2) - (w/2);
    let top  = anchorRect.top - h - 10;

    const vw = window.innerWidth;
    const vh = window.innerHeight;

    if (left < margin) left = margin;
    if (left + w > vw - margin) left = vw - margin - w;

    if (top < margin){
      top = anchorRect.bottom + 10;
      if (top + h > vh - margin) top = Math.max(margin, vh - margin - h);
    }

    tip.style.left = left + "px";
    tip.style.top  = top + "px";
  }

  function hideTip(){
    tip.classList.remove("show");
    tip.setAttribute("aria-hidden","true");
  }

  function attachTooltipHandlers(){
    document.addEventListener("mouseover", (e) => {
      const t = e.target.closest?.(".info[data-tip]");
      if (!t) return;
      showTip(t.dataset.tip, t.getBoundingClientRect());
    });
    document.addEventListener("mouseout", (e) => {
      const t = e.target.closest?.(".info[data-tip]");
      if (!t) return;
      const related = e.relatedTarget;
      if (related && (related === tip || tip.contains(related))) return;
      hideTip();
    });
    document.addEventListener("click", (e) => {
      const info = e.target.closest?.(".info[data-tip]");
      if (info){
        showTip(info.dataset.tip, info.getBoundingClientRect());
        return;
      }
      if (tip.classList.contains("show") && !tip.contains(e.target)) hideTip();
    });
    tip.addEventListener("mouseleave", hideTip);
    $("#tipClose").addEventListener("click", hideTip);
    document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") hideTip(); });
  }

  // --- Buttons ---
  $("#btnScore").addEventListener("click", compute);
  $("#btnReset").addEventListener("click", resetAll);

  // Export dialog
  const dlg = $("#exportDlg");
  $("#btnExport").addEventListener("click", () => {
    if (dlg?.showModal) dlg.showModal();
    else {
      const choice = window.prompt("Exporter : 1=HTML, 2=PDF, 3=JSON", "1");
      if (choice === "2") exportReportPdf();
      else if (choice === "3") exportJsonTech();
      else exportReportHtml();
    }
  });
  $("#expCancel").addEventListener("click", ()=> dlg.close());
  $("#expHtml").addEventListener("click", ()=> { dlg.close(); exportReportHtml(); });
  $("#expPdf").addEventListener("click", ()=> { dlg.close(); exportReportPdf(); });
  $("#expJson").addEventListener("click", ()=> { dlg.close(); exportJsonTech(); });

  $("#openAll").addEventListener("click", () => { $$("#completed details").forEach(d => d.open = true); });
  $("#closeAll").addEventListener("click", () => { $$("#completed details").forEach(d => d.open = false); });
  $("#showAllQs").addEventListener("click", () => {
    window.__showAll = !window.__showAll;
    $("#showAllQs").textContent = window.__showAll ? "Masquer les questions répondues" : "Afficher toutes les questions";
    applyHideAnswered();
  });

  // Init
  render();
  attachTooltipHandlers();
</script>
</body>
</html>
